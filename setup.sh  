#!/bin/bash

# Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†ØµØ¨ Ú©Ø§Ù…Ù„ Ù¾Ø§Ú©Øª Ø¨ÛŒØ³ - ÙÙ‚Ø· ÛŒÚ© Ø¯Ø³ØªÙˆØ±!
# Usage: curl -sSL https://raw.githubusercontent.com/heydarlouam/pb-setup-scripts/main/setup.sh | bash

set -e

# Ø±Ù†Ú¯â€ŒÙ‡Ø§
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${GREEN}[$(date +'%H:%M:%S')]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }

# Ù†Ù…Ø§ÛŒØ´ Ø¨Ù†Ø±
show_banner() {
    echo -e "${GREEN}"
    cat << "EOF"
    
â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•
                                                                      
    ğŸ½ï¸  Auto Deployer - One Command Setup ğŸš€
EOF
    echo -e "${NC}"
}

# Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ø¨ Ø¯Ø§Ù…ÛŒÙ†
get_subdomain() {
    echo -e "${YELLOW}ğŸŒ Ù„Ø·ÙØ§Ù‹ Ø³Ø§Ø¨ Ø¯Ø§Ù…ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:${NC}"
    echo -e "${BLUE}Ù…Ø«Ø§Ù„: pb, admin, api${NC}"
    read -p "Ø³Ø§Ø¨ Ø¯Ø§Ù…ÛŒÙ†: " SUBDOMAIN
    
    if [ -z "$SUBDOMAIN" ]; then
        error "Ø³Ø§Ø¨ Ø¯Ø§Ù…ÛŒÙ† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯"
    fi
    
    DOMAIN="${SUBDOMAIN}.frozencoffee.ir"
    log "Ø¯Ø§Ù…ÛŒÙ† ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯: $DOMAIN"
}

# Ø¨Ø±Ø±Ø³ÛŒ root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø¯Ø³ØªÙˆØ± sudo Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯: sudo bash setup.sh"
    fi
}

# Ø¢Ù¾Ø¯ÛŒØª Ø³ÛŒØ³ØªÙ…
update_system() {
    log "Ø¢Ù¾Ø¯ÛŒØª Ø³ÛŒØ³ØªÙ…..."
    apt update && apt upgrade -y
}

# Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
install_dependencies() {
    log "Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§..."
    apt install -y curl wget unzip nginx certbot python3-certbot-nginx
}

# Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Ù¾Ø§Ú©Øª Ø¨ÛŒØ³
install_pocketbase() {
    log "Ù†ØµØ¨ Ù¾Ø§Ú©Øª Ø¨ÛŒØ³..."
    mkdir -p /root/pocketbase
    cd /root/pocketbase
    
    PB_VERSION="0.22.21"
    rm -f pocketbase*
    
    curl -L -o pocketbase_${PB_VERSION}_linux_amd64.zip \
        "https://github.com/pocketbase/pocketbase/releases/download/v${PB_VERSION}/pocketbase_${PB_VERSION}_linux_amd64.zip"
    
    unzip pocketbase_${PB_VERSION}_linux_amd64.zip
    rm pocketbase_${PB_VERSION}_linux_amd64.zip
    chmod +x pocketbase
    
    log "Ù¾Ø§Ú©Øª Ø¨ÛŒØ³ Ù†ØµØ¨ Ø´Ø¯"
}

# Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³
create_service() {
    log "Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³ systemd..."
    
    cat > /etc/systemd/system/pocketbase.service << EOF
[Unit]
Description=PocketBase Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/pocketbase
ExecStart=/root/pocketbase/pocketbase serve --http="0.0.0.0:8090"
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable pocketbase.service
    log "Ø³Ø±ÙˆÛŒØ³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
}

# ØªÙ†Ø¸ÛŒÙ… nginx
setup_nginx() {
    log "ØªÙ†Ø¸ÛŒÙ… nginx Ø¨Ø±Ø§ÛŒ $DOMAIN..."
    
    cat > /etc/nginx/sites-available/${DOMAIN} << EOF
server {
    listen 80;
    server_name $DOMAIN;
    
    location / {
        proxy_pass http://127.0.0.1:8090;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    ln -sf /etc/nginx/sites-available/${DOMAIN} /etc/nginx/sites-enabled/
    rm -f /etc/nginx/sites-enabled/default
    nginx -t && systemctl reload nginx
    log "nginx ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯"
}

# Ù†ØµØ¨ SSL
setup_ssl() {
    log "Ù†ØµØ¨ SSL Ø¨Ø±Ø§ÛŒ $DOMAIN..."
    warning "Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Cloudflare Ø±ÙˆÛŒ DNS-only Ø¨Ø§Ø´Ø¯"
    read -p "Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ (Enter) " -n 1 -r
    
    certbot --nginx -d $DOMAIN --non-interactive --agree-tos \
        --email phone.sync.heydarloo@gmail.com --redirect
    log "SSL Ù†ØµØ¨ Ø´Ø¯"
}

# Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ restore backup
restore_backup() {
    log "Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ restore backup..."
    
    cd /root/pocketbase
    
    # Ø¯Ø§Ù†Ù„ÙˆØ¯ backup Ø§Ø² GitHub
    BACKUP_URL="https://github.com/heydarlouam/pb-setup-scripts/raw/main/pocketbase_backup.zip"
    
    if curl -L -o backup.zip "$BACKUP_URL"; then
        log "Backup Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯"
    else
        error "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ backup"
    fi
    
    # ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³ Ùˆ restore
    systemctl stop pocketbase.service
    unzip -o backup.zip
    rm backup.zip
    systemctl start pocketbase.service
    
    log "Backup restore Ø´Ø¯"
}

# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
check_final_status() {
    log "Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ..."
    sleep 5
    
    echo -e "\n${GREEN}âœ… ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:${NC}"
    systemctl status pocketbase.service --no-pager
    
    echo -e "\n${GREEN}ğŸŒ ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ:${NC}"
    if curl -s -I https://$DOMAIN/ > /dev/null; then
        log "Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ $DOMAIN Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª"
    else
        warning "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ $DOMAIN"
    fi
}

# Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
show_success() {
    echo -e "\n${GREEN}"
    echo "ğŸ‰ ğŸ‰ ğŸ‰ Ù†ØµØ¨ Ú©Ø§Ù…Ù„ Ø´Ø¯! ğŸ‰ ğŸ‰ ğŸ‰"
    echo -e "${NC}"
    
    echo -e "${YELLOW}ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ:${NC}"
    echo -e "ğŸŒ Ø¢Ø¯Ø±Ø³ Ø§ØµÙ„ÛŒ: ${GREEN}https://$DOMAIN${NC}"
    echo -e "ğŸ”§ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†: ${GREEN}https://$DOMAIN/_/${NC}"
    echo -e "ğŸ“š API: ${GREEN}https://$DOMAIN/api/${NC}"
    
    echo -e "\n${YELLOW}âš™ï¸  Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:${NC}"
    echo -e "ÙˆØ¶Ø¹ÛŒØª: ${GREEN}systemctl status pocketbase${NC}"
    echo -e "Ø±Ø³ØªØ§Ø±Øª: ${GREEN}systemctl restart pocketbase${NC}"
    echo -e "Ù„Ø§Ú¯: ${GREEN}journalctl -u pocketbase -f${NC}"
    
    echo -e "\n${GREEN}âœ… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!${NC}"
}

# ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ
main() {
    show_banner
    get_subdomain
    check_root
    
    log "Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ù†ØµØ¨ Ø¨Ø±Ø§ÛŒ $DOMAIN..."
    
    # Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„
    update_system
    install_dependencies
    install_pocketbase
    create_service
    setup_nginx
    setup_ssl
    restore_backup
    check_final_status
    show_success
}

# Ø§Ø¬Ø±Ø§
main "$@"